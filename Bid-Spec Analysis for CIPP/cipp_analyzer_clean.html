<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIPP Bid-Spec Analyzer - MPT Tools</title>
    <!-- SheetJS Library for Professional Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Chart.js for Interactive Dashboards -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding: 0;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('/shared/assets/images/bg3.jpg');
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            filter: brightness(0.75);
            z-index: -2;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(91, 127, 204, 0.4) 0%, rgba(30, 58, 138, 0.5) 100%);
            z-index: -1;
        }

        .container {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(2.5px);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
            max-width: 1000px;
            width: calc(100% - 40px);
            min-height: 600px;
            margin: 20px auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #ffffff;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #ffffff;
            font-size: 1.1em;
        }

        .section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid rgba(224, 224, 224, 0.5);
            border-radius: 8px;
            background: transparent;
        }

        .section h3 {
            color: #ffffff;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #ffffff;
            font-weight: 500;
        }

        input[type="text"], input[type="password"], input[type="file"], input[type="number"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, input[type="password"]:focus, input[type="number"]:focus, textarea:focus {
            outline: none;
            border-color: #5B7FCC;
        }

        .file-upload {
            border: 2px dashed rgba(221, 221, 221, 0.7);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
        }

        .file-upload:hover {
            border-color: #5B7FCC;
            background: rgba(248, 249, 255, 0.95);
        }

        .btn {
            background: linear-gradient(45deg, #5B7FCC, #1E3A8A);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-test {
            background: #28a745;
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #5B7FCC, #1E3A8A);
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            color: #ffffff;
        }

        .log-container {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            display: none;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
            white-space: pre-wrap;
        }

        .log-info { color: #17a2b8; }
        .log-success { color: #28a745; }
        .log-warning { color: #ffc107; }
        .log-error { color: #dc3545; }
        .log-debug { color: #6f42c1; }
        .log-api { color: #fd7e14; background: #fff3cd; padding: 5px; border-radius: 3px; }
        .log-request { color: #0056b3; background: #cce5ff; padding: 5px; border-radius: 3px; }
        .log-response { color: #155724; background: #d4edda; padding: 5px; border-radius: 3px; }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-ready { background: #28a745; }
        .status-processing { background: #ffc107; }
        .status-error { background: #dc3545; }

        .results-section {
            display: none;
            margin-top: 20px;
        }

        .question-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .question-section {
            border: 1px solid rgba(221, 221, 221, 0.6);
            border-radius: 6px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            cursor: pointer;
            transition: all 0.3s;
        }

        .question-section:hover {
            border-color: #5B7FCC;
            background: rgba(255, 255, 255, 0.95);
        }

        .question-section.enabled {
            border-color: #28a745;
            background: rgba(248, 255, 248, 0.9);
        }

        .question-section.disabled {
            border-color: #dc3545;
            background: rgba(255, 248, 248, 0.9);
            opacity: 0.7;
        }

        .section-header {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-count {
            font-size: 12px;
            color: #666;
            background: #f0f0f0;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .service-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            text-align: center;
        }

        .service-running {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .service-stopped {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        /* Export menu button hover */
        #exportMenu button:hover {
            background: #f0f0f0 !important;
            font-weight: 500;
        }

        #exportMenu button:active {
            background: #e0e0e0 !important;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            font-weight: bold;
        }

        .close-btn:hover {
            color: #666;
        }

        /* Collapsible Debug Sections */
        .debug-panel {
            margin: 20px auto;
            max-width: 1200px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            animation: slideDown 0.3s ease-out;
            overflow: hidden;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
                max-height: 0;
            }
            to {
                opacity: 1;
                transform: translateY(0);
                max-height: 2000px;
            }
        }

        .debug-section {
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .debug-section-header {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            transition: all 0.3s;
            user-select: none;
        }

        .debug-section-header:hover {
            background: linear-gradient(135deg, #5a6268, #3d4246);
        }

        .debug-section-header .toggle-icon {
            font-size: 20px;
            transition: transform 0.3s;
        }

        .debug-section-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .debug-section-content {
            padding: 20px;
            display: none;
        }

        .debug-section-content.expanded {
            display: block;
        }

        .debug-button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        /* Industry Dashboard Panels */
        .dashboard-container {
            display: none; /* Hidden until analysis starts */
            margin: 30px 0;
            padding: 25px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #5B7FCC;
        }

        .dashboard-header h2 {
            color: #1E3A8A;
            font-size: 1.8em;
            margin-bottom: 8px;
        }

        .dashboard-header p {
            color: #666;
            font-size: 0.95em;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .dashboard-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e0e0;
            transition: all 0.3s;
        }

        .dashboard-panel:hover {
            box-shadow: 0 4px 12px rgba(91, 127, 204, 0.15);
            transform: translateY(-2px);
        }

        .dashboard-panel h3 {
            color: #1E3A8A;
            font-size: 1.1em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dashboard-panel canvas {
            max-height: 300px;
        }

        .dashboard-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .dashboard-metric:last-child {
            border-bottom: none;
        }

        .dashboard-metric-label {
            color: #666;
            font-size: 0.9em;
        }

        .dashboard-metric-value {
            font-weight: 600;
            font-size: 1.1em;
            color: #1E3A8A;
        }

        .dashboard-metric-value.high {
            color: #dc3545;
        }

        .dashboard-metric-value.medium {
            color: #ffc107;
        }

        .dashboard-metric-value.low {
            color: #28a745;
        }

        .dashboard-full-width {
            grid-column: 1 / -1;
        }

        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* MPT Navbar */
        .mpt-navbar {
            background: linear-gradient(135deg, #1E3A8A, #5B7FCC);
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            margin-bottom: 0;
        }

        .mpt-navbar .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .mpt-navbar img {
            height: 40px;
            width: auto;
        }

        .mpt-navbar .app-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .mpt-navbar .home-link {
            color: white;
            text-decoration: none;
            padding: 8px 20px;
            border: 2px solid white;
            border-radius: 5px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .mpt-navbar .home-link:hover {
            background-color: white;
            color: #1E3A8A;
        }

        /* Mobile responsive for navbar and background */
        @media (max-width: 768px) {
            body::before {
                background-attachment: scroll;
                background-size: cover;
                background-position: center center;
            }

            .mpt-navbar {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            .container {
                padding: 20px;
                width: calc(100% - 20px);
                margin: 10px auto;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .header p {
                font-size: 1em;
            }
        }

        @media (max-width: 480px) {
            body::before {
                background-size: auto 100%;
                background-position: center center;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .container {
                padding: 15px;
            }
        }

        /* Dashboard Responsive Styles */
        @media (max-width: 1200px) {
            #dashboardSection .dashboard-card {
                grid-column: span 1 !important;
            }

            #dashboardSection > div {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 768px) {
            #dashboardSection h3 {
                font-size: 1.3em;
            }

            #dashboardSection p {
                font-size: 0.9em;
            }

            .dashboard-card {
                padding: 15px !important;
            }

            .dashboard-card h4 {
                font-size: 1em !important;
                margin-bottom: 10px !important;
            }

            .dashboard-card canvas {
                max-height: 250px !important;
            }

            #competitivenessGauge {
                max-width: 250px !important;
                max-height: 250px !important;
            }

            #competitivenessSummary {
                padding: 15px !important;
                font-size: 0.85em;
            }

            #competitivenessSummary h4 {
                font-size: 1.1em !important;
            }
        }

        @media (max-width: 480px) {
            #dashboardSection h3 {
                font-size: 1.1em;
            }

            #dashboardSection > div {
                gap: 15px !important;
            }

            .dashboard-card {
                padding: 12px !important;
                border-radius: 8px !important;
            }

            .dashboard-card h4 {
                font-size: 0.95em !important;
            }

            .dashboard-card canvas {
                max-height: 200px !important;
            }

            #competitivenessGauge {
                max-width: 200px !important;
                max-height: 200px !important;
            }

            #competitivenessSummary {
                font-size: 0.8em;
                line-height: 1.5 !important;
            }

            #riskSummary, #costSummary, #complianceSummary, #timelineSummary {
                font-size: 0.85em !important;
                padding: 8px !important;
            }
        }
    </style>
</head>
<body>
    <!-- MPT Navigation Bar -->
    <nav class="mpt-navbar">
        <div class="logo-container">
            <img src="/shared/assets/images/logo.png" alt="Municipal Pipe Tool">
            <span class="app-title">CIPP Bid-Spec Analyzer</span>
        </div>
        <a href="/" class="home-link">â† Home</a>
    </nav>

    <div class="container">
        <div class="header">
            <h1>ğŸ—ï¸ CIPP Bid-Spec Analyzer</h1>
            <p>Professional bid specification analysis powered by AI</p>
        </div>

        <!-- File Upload Section -->
        <div class="section">
            <h3>ğŸ“„ Document Upload</h3>
            <div class="file-upload" id="fileUpload" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" style="display: none;" accept=".pdf,.txt,.docx,.rtf" onchange="handleFileSelect(event)">
                <p><strong>Click to select file</strong> or drag and drop</p>
                <p>Supported formats: PDF, TXT, DOCX, RTF</p>
            </div>
            <div id="fileInfo" style="margin-top: 10px; display: none;">
                <p><strong>Selected file:</strong> <span id="fileName"></span></p>
                <p><strong>Size:</strong> <span id="fileSize"></span></p>
            </div>
            <button class="btn btn-test" onclick="loadTestDocument()" style="margin-top: 10px;">ğŸ“‹ Load Test Document</button>
        </div>

        <!-- Question Management Section -->
        <div class="section">
            <h3>â“ Question Configuration</h3>
            <div class="form-group">
                <label>Question Sections (Click to enable/disable):</label>
                <div id="questionSections" class="question-sections"></div>
            </div>
            <div class="form-group">
                <label>Active Questions: <span id="activeQuestionCount">0</span> questions selected</label>
            </div>

            <!-- Context Guardrails Input -->
            <div class="form-group" style="margin-top: 20px; padding: 15px; background: rgba(91, 127, 204, 0.05); border-radius: 8px; border: 2px dashed rgba(91, 127, 204, 0.3);">
                <label for="contextGuardrails" style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <span style="font-size: 1.2em;">ğŸ“‹</span>
                    <strong>Context Guardrails (Optional)</strong>
                </label>
                <textarea
                    id="contextGuardrails"
                    placeholder="Enter background rules or context constraints (e.g., 'Only answer questions in regard to CIPP lining' or 'Answer within the context of the medical industry')"
                    style="width: 100%; min-height: 80px; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;"
                    oninput="saveContextGuardrails()"
                ></textarea>
                <small style="color: #666; display: block; margin-top: 8px;">
                    <strong>What are Context Guardrails?</strong> Global rules applied to ALL questions in the analysis.
                    Use this to focus the AI's attention on specific contexts or formats.
                </small>
                <div id="activeGuardrailsDisplay" style="display: none; margin-top: 12px; padding: 10px; background: rgba(34, 197, 94, 0.1); border-left: 4px solid #22c55e; border-radius: 4px;">
                    <strong style="color: #22c55e;">âœ“ Active Guardrails:</strong>
                    <p id="activeGuardrailsText" style="margin: 5px 0 0 0; color: #333; font-style: italic;"></p>
                </div>
            </div>

            <button class="btn btn-secondary" onclick="showQuestionManager()">ğŸ“ Manage Questions</button>
            <button class="btn btn-secondary" onclick="addQuestionSection()">â• Add Custom Section</button>
            <button class="btn btn-secondary" onclick="exportQuestions()">ğŸ“¤ Export Questions</button>
            <button class="btn btn-secondary" onclick="showSettings()">âš™ï¸ Settings</button>
        </div>

        <!-- Analysis Controls & Debug Tools -->
        <div class="section">
            <h3>ğŸ¯ Analysis Controls</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                <button class="btn" id="analyzeBtn" onclick="startAnalysis()" disabled>ğŸš€ Start Analysis (Pass 1)</button>
                <button class="btn" id="secondPassBtn" onclick="runSecondPass()" disabled style="background: linear-gradient(45deg, #f59e0b, #d97706); display: none;">
                    ğŸ” Run Second Pass
                </button>
                <button class="btn btn-danger" id="stopBtn" onclick="stopAnalysis()" disabled>â¹ï¸ Stop Analysis</button>
                <button class="btn btn-secondary" onclick="clearResults()">ğŸ—‘ï¸ Clear Results</button>
            </div>

            <!-- Second Pass Info Banner -->
            <div id="secondPassBanner" style="display: none; padding: 15px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(217, 119, 6, 0.1) 100%); border-left: 4px solid #f59e0b; border-radius: 6px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 2em;">ğŸ”</span>
                    <div style="flex: 1;">
                        <strong style="color: #f59e0b; font-size: 1.1em;">Second Pass Available!</strong>
                        <p style="margin: 5px 0 0 0; color: #666;">
                            <span id="unansweredCount">0</span> questions remain unanswered.
                            Run a second pass with <strong>enhanced scrutiny</strong> to find difficult-to-locate answers.
                        </p>
                    </div>
                    <button class="btn" onclick="runSecondPass()" style="background: linear-gradient(45deg, #f59e0b, #d97706); white-space: nowrap;">
                        Run Second Pass â†’
                    </button>
                </div>
            </div>
            <div class="btn-group" style="display: inline-block; position: relative;">
                <button class="btn btn-secondary" onclick="showExportMenu()" id="exportBtn" disabled>ğŸ“Š Export Results â–¼</button>
                <div id="exportMenu" style="display: none; position: absolute; background: white; border: 2px solid #ddd; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; min-width: 280px; top: 100%; left: 0; margin-top: 5px;">
                    <button onclick="exportExcelDashboard()" style="width: 100%; padding: 14px; border: none; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; text-align: left; cursor: pointer; border-bottom: 1px solid #eee; font-weight: 700; font-size: 15px;">ğŸ“Š Excel Dashboard (Charts) â­</button>
                    <button onclick="exportResults('excel-simple')" style="width: 100%; padding: 12px; border: none; background: white; text-align: left; cursor: pointer; border-bottom: 1px solid #eee; color: #666;">âœ¨ Excel (Styled Table)</button>
                    <button onclick="exportResults('csv')" style="width: 100%; padding: 12px; border: none; background: white; text-align: left; cursor: pointer; border-bottom: 1px solid #eee; color: #666;">ğŸ“„ CSV (Simple)</button>
                    <button onclick="exportResults('html')" style="width: 100%; padding: 12px; border: none; background: white; text-align: left; cursor: pointer; border-bottom: 1px solid #eee; color: #666;">ğŸŒ HTML Report</button>
                    <button onclick="exportResults('markdown')" style="width: 100%; padding: 12px; border: none; background: white; text-align: left; cursor: pointer; border-bottom: 1px solid #eee; color: #666;">ğŸ“ Markdown Table</button>
                    <button onclick="exportResults('json')" style="width: 100%; padding: 12px; border: none; background: white; text-align: left; cursor: pointer; color: #666;">ğŸ“‹ JSON Data</button>
                </div>
            </div>
        </div>

        <!-- Collapsible Debug/Development Panel -->
        <!-- Master Debug Toggle Button -->
        <div style="text-align: center; margin: 20px 0;">
            <button class="btn" onclick="toggleMasterDebugPanel()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; font-size: 16px; border: none; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                <span id="masterDebugToggleIcon">ğŸ› ï¸</span> <span id="masterDebugToggleText">Show Debug Tools</span>
            </button>
        </div>

        <div class="debug-panel" id="masterDebugPanel" style="display: none;">
            <h3 style="text-align: center; color: #495057; margin-bottom: 20px;">ğŸ› ï¸ Advanced Configuration & Debug Tools</h3>

            <!-- Analysis Configuration (Collapsible) -->
            <div class="debug-section">
                <div class="debug-section-header collapsed" onclick="toggleDebugSection('analysisConfigSection')">
                    <span>âš™ï¸ Analysis Configuration</span>
                    <span class="toggle-icon">â–¼</span>
                </div>
                <div id="analysisConfigSection" class="debug-section-content">
                    <div class="form-group">
                        <label for="chunkSize">Characters per Analysis Chunk:</label>
                        <input type="number" id="chunkSize" value="1500" min="500" max="2000">
                        <small>Recommended: 1500 characters per chunk to stay within token limits</small>
                    </div>
                </div>
            </div>

            <!-- PDF Service Status (Collapsible) -->
            <div class="debug-section">
                <div class="debug-section-header collapsed" onclick="toggleDebugSection('pdfServiceSection')">
                    <span>ğŸ“„ PDF Service Status</span>
                    <span class="toggle-icon">â–¼</span>
                </div>
                <div id="pdfServiceSection" class="debug-section-content">
                    <div id="serviceStatus" class="service-status service-stopped">
                        <span id="serviceStatusText">ğŸ“„ Checking document extraction service...</span>
                    </div>
                </div>
            </div>

            <!-- API Configuration (Collapsible) -->
            <div class="debug-section">
                <div class="debug-section-header collapsed" onclick="toggleDebugSection('apiConfigSection')">
                    <span><span class="status-indicator" id="apiStatus"></span>API Configuration</span>
                    <span class="toggle-icon">â–¼</span>
                </div>
                <div id="apiConfigSection" class="debug-section-content">
                    <div class="form-group">
                        <p id="apiStatusText">Loading API configuration...</p>
                    </div>
                    <div class="debug-button-group">
                        <button class="btn btn-test" id="testConnectionBtn" onclick="testApiConnection()">ğŸ”— Test Connection</button>
                        <span id="testStatusDisplay" style="font-weight: 500; padding: 8px 16px; border-radius: 6px; display: none;"></span>
                    </div>
                </div>
            </div>

            <!-- Activity Log (Collapsible) -->
            <div class="debug-section">
                <div class="debug-section-header collapsed" onclick="toggleDebugSection('logSection')">
                    <span>ğŸ“‹ Activity Log</span>
                    <span class="toggle-icon">â–¼</span>
                </div>
                <div id="logSection" class="debug-section-content">
                    <div class="debug-button-group">
                        <button class="btn btn-secondary" onclick="exportLog()">ğŸ’¾ Export Log</button>
                        <button class="btn btn-secondary" onclick="clearLog()">ğŸ—‘ï¸ Clear Log</button>
                    </div>
                    <div class="log-container" id="logContainer" style="display: block; margin-top: 15px;">
                        <div id="logContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Ready</div>
        </div>

        <!-- Legacy Dashboard Section REMOVED - Replaced by dashboardSection below (lines 924-980) -->
        <!-- REASON: Duplicate canvas IDs caused Chart.js render conflicts -->

        <!-- Live Results Section -->
        <div class="results-section" id="resultsSection" style="display: none;">
            <h3>ğŸ“‹ Analysis Results (Live Updates)</h3>
            <div id="liveResultsContainer">
                <div id="liveResultsTable"></div>
                <div id="resultsContent"></div>
            </div>
        </div>

        <!-- Industry Intelligence Dashboard - Collapsible Container -->
        <div style="text-align: center; margin: 30px 0;" id="dashboardButtonContainer" style="display: none;">
            <button class="btn" onclick="toggleDashboardPanel()" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 15px 32px; font-size: 18px; font-weight: 600; border: none; box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4); transition: all 0.3s ease;">
                <span id="dashboardToggleIcon">ğŸ“Š</span> <span id="dashboardToggleText">Show Industry Intelligence Dashboards</span>
            </button>
            <p style="color: #6c757d; margin-top: 10px; font-size: 14px;">Interactive visualizations of your bid specification analysis</p>
        </div>

        <div class="results-section" id="dashboardSection" style="display: none; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="text-align: center; margin-bottom: 30px; position: relative;">
                <h2 style="color: #fff; font-size: 2em; margin-bottom: 10px;">ğŸ“Š CIPP Industry Intelligence Dashboards</h2>
                <button onclick="refreshDashboards()" class="btn" style="position: absolute; right: 0; top: 0; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 10px 20px; font-size: 14px; font-weight: 600; transition: all 0.3s ease; backdrop-filter: blur(10px);" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    ğŸ”„ Refresh
                </button>
                <p style="color: rgba(255,255,255,0.9); font-size: 1.1em;">Visual insights extracted from your bid specification analysis</p>
            </div>

            <!-- Dashboard Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px; margin-top: 20px;">

                <!-- Risk Assessment Matrix -->
                <div class="dashboard-card" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <h4 style="color: #5B7FCC; margin-bottom: 15px; font-size: 1.2em;">
                        ğŸ¯ Risk Assessment Matrix
                    </h4>
                    <canvas id="riskMatrixChart" style="max-height: 300px;"></canvas>
                    <div id="riskSummary" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 0.9em;"></div>
                </div>

                <!-- Cost Driver Breakdown -->
                <div class="dashboard-card" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <h4 style="color: #5B7FCC; margin-bottom: 15px; font-size: 1.2em;">
                        ğŸ’° Cost Driver Breakdown
                    </h4>
                    <canvas id="costDriverChart" style="max-height: 300px;"></canvas>
                    <div id="costSummary" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 0.9em;"></div>
                </div>

                <!-- Compliance Scorecard -->
                <div class="dashboard-card" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <h4 style="color: #5B7FCC; margin-bottom: 15px; font-size: 1.2em;">
                        âœ… Compliance Scorecard
                    </h4>
                    <canvas id="complianceChart" style="max-height: 300px;"></canvas>
                    <div id="complianceSummary" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 0.9em;"></div>
                </div>

                <!-- Timeline & Milestones -->
                <div class="dashboard-card" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <h4 style="color: #5B7FCC; margin-bottom: 15px; font-size: 1.2em;">
                        ğŸ“… Timeline & Key Milestones
                    </h4>
                    <canvas id="timelineChart" style="max-height: 300px;"></canvas>
                    <div id="timelineSummary" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 0.9em;"></div>
                </div>

                <!-- Bid Competitiveness Gauge -->
                <div class="dashboard-card" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); grid-column: span 2;">
                    <h4 style="color: #5B7FCC; margin-bottom: 15px; font-size: 1.2em;">
                        ğŸ† Bid Competitiveness Gauge
                    </h4>
                    <div style="display: flex; gap: 30px; align-items: center;">
                        <canvas id="competitivenessGauge" style="max-width: 300px; max-height: 300px;"></canvas>
                        <div id="competitivenessSummary" style="flex: 1; padding: 20px; background: #f8f9fa; border-radius: 6px;"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="hideSettings()">&times;</button>
            <h2>âš™ï¸ Application Settings</h2>
            <div class="form-group">
                <p style="padding: 15px; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 4px;">
                    <strong>â„¹ï¸ API Key Configuration</strong><br>
                    The OpenAI API key is configured via environment variables on the server.
                    Contact your system administrator to update the API key.
                </p>
            </div>
            <div class="form-group">
                <label for="gptModel">GPT Model:</label>
                <select id="gptModel">
                    <option value="gpt-4o">GPT-4o (Recommended - 128K context)</option>
                    <option value="gpt-4-turbo">GPT-4 Turbo (128K context)</option>
                    <option value="gpt-4">GPT-4 (8K context - may fail on large docs)</option>
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo (16K context)</option>
                </select>
            </div>
            <button class="btn" onclick="saveSettings()">ğŸ’¾ Save Settings</button>
            <button class="btn btn-secondary" onclick="hideSettings()">âŒ Close</button>
        </div>
    </div>

    <!-- Question Manager Modal -->
    <div id="questionManagerModal" class="modal">
        <div class="modal-content" style="max-width: 95%; max-height: 90%;">
            <button class="close-btn" onclick="hideQuestionManager()">&times;</button>
            <h2>ğŸ“ Question Manager</h2>

            <div style="margin-bottom: 20px;">
                <label>Select Section to Edit:</label>
                <select id="sectionSelect" onchange="loadSectionForEdit()" style="width: 100%; padding: 8px; margin: 10px 0;">
                    <option value="">-- Select a section --</option>
                </select>
                <button class="btn btn-secondary" onclick="addNewSectionInManager()">â• Add New Section</button>
                <button class="btn btn-danger" onclick="deleteCurrentSection()">ğŸ—‘ï¸ Delete Section</button>
            </div>

            <div id="sectionEditor" style="display: none;">
                <h3 id="currentSectionName"></h3>
                <div style="margin-bottom: 15px;">
                    <label>
                        <input type="checkbox" id="sectionEnabled" onchange="toggleSectionEnabled()">
                        Section Enabled
                    </label>
                </div>

                <div style="margin-bottom: 15px;">
                    <label>Section Name:</label>
                    <input type="text" id="sectionNameInput" onchange="updateSectionName()" style="width: 100%; padding: 8px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label>Questions in this section:</label>
                    <div id="questionsList" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 6px; background: #f9f9f9;"></div>
                    <button class="btn btn-secondary" onclick="addNewQuestion()" style="margin-top: 10px;">â• Add Question</button>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn" onclick="saveQuestions()">ğŸ’¾ Save All Changes</button>
                <button class="btn btn-secondary" onclick="hideQuestionManager()">âŒ Close</button>
                <button class="btn btn-secondary" onclick="exportQuestions()">ğŸ“¤ Export Questions</button>
                <input type="file" id="importQuestionsFile" style="display: none;" accept=".json" onchange="importQuestions(event)">
                <button class="btn btn-secondary" onclick="document.getElementById('importQuestionsFile').click()">ğŸ“¥ Import Questions</button>
            </div>
        </div>
    </div>

    <script>
// ============================================================================
// CIPP ANALYZER - CLEAN JAVASCRIPT (Rebuilt from Scratch)
// ============================================================================

// Global State
let currentFile = null;
let currentSessionId = null;
let currentAnalysisResult = null;
let activeEventSource = null;
let questionConfig = {
    sections: [],
    totalQuestions: 0
};

// ============================================================================
// LOGGER - Simple, Working (Exactly like legacy that worked)
// ============================================================================

class Logger {
    static log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logContainer = document.getElementById('logContent');
        const entry = document.createElement('div');
        entry.className = `log-entry log-${type}`;

        if (typeof message === 'object') {
            entry.innerHTML = `[${timestamp}] <pre>${JSON.stringify(message, null, 2)}</pre>`;
        } else {
            entry.textContent = `[${timestamp}] ${message}`;
        }

        logContainer.appendChild(entry);
        logContainer.scrollTop = logContainer.scrollHeight;
        document.getElementById('logContainer').style.display = 'block';
    }

    static info(msg) { this.log(msg, 'info'); }
    static success(msg) { this.log(msg, 'success'); }
    static error(msg) { this.log(msg, 'error'); }
    static warning(msg) { this.log(msg, 'warning'); }
    static debug(msg) { this.log(msg, 'debug'); }
}

// ============================================================================
// PROGRESS TRACKER
// ============================================================================

class ProgressTracker {
    static show() {
        document.getElementById('progressContainer').style.display = 'block';
    }

    static hide() {
        document.getElementById('progressContainer').style.display = 'none';
    }

    static update(percentage, text) {
        document.getElementById('progressFill').style.width = `${percentage}%`;
        document.getElementById('progressText').textContent = text;
    }
}

// ============================================================================
// FILE UPLOAD HANDLING
// ============================================================================

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    currentFile = file;

    // Update UI
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);
    document.getElementById('fileInfo').style.display = 'block';
    document.getElementById('analyzeBtn').disabled = false;

    Logger.info(`ğŸ“„ PDF file selected: ${file.name}`);
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

// ============================================================================
// ANALYSIS - Main Flow (CLEAN, SIMPLE)
// ============================================================================

async function startAnalysis() {
    if (!currentFile) {
        Logger.error('Please upload a PDF file first');
        alert('Please upload a PDF file first');
        return;
    }

    try {
        Logger.info('ğŸ”¥ Starting HOTDOG AI analysis...');

        // Get context guardrails
        const contextGuardrails = document.getElementById('contextGuardrails').value.trim();
        if (contextGuardrails) {
            Logger.info(`ğŸ“‹ Context Guardrails: ${contextGuardrails}`);
        }

        // Disable/enable buttons
        document.getElementById('analyzeBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;

        // Show progress
        ProgressTracker.show();
        ProgressTracker.update(10, 'Uploading document...');

        // STEP 1: Upload PDF
        const formData = new FormData();
        formData.append('file', currentFile);

        const uploadResp = await fetch('/api/upload', {
            method: 'POST',
            body: formData
        });

        if (!uploadResp.ok) {
            throw new Error('File upload failed');
        }

        const uploadData = await uploadResp.json();
        const pdfPath = uploadData.filepath;

        Logger.success(`âœ… File uploaded: ${pdfPath}`);
        ProgressTracker.update(20, 'Connecting to HOTDOG AI...');

        // Generate session ID
        currentSessionId = `session_${Date.now()}`;

        // Save session state for resume support
        saveSessionState();

        // STEP 2: Connect to SSE BEFORE starting analysis
        const progressUrl = `/api/progress/${currentSessionId}`;
        activeEventSource = new EventSource(progressUrl);

        activeEventSource.onopen = () => {
            Logger.info('ğŸ“¡ Connected to live progress stream');
        };

        activeEventSource.onmessage = (e) => {
            try {
                const data = JSON.parse(e.data);

                // Route events (SIMPLE - just call Logger)
                if (data.event === 'connected') {
                    Logger.success('âœ… Progress stream connected');
                }
                else if (data.event === 'document_ingested') {
                    Logger.info(`ğŸ“„ Extracted ${data.total_pages} pages into ${data.window_count} windows`);
                    ProgressTracker.update(30, `Extracted ${data.total_pages} pages`);
                }
                else if (data.event === 'config_loaded') {
                    Logger.info(`âš™ï¸ Loaded ${data.total_questions} questions in ${data.section_count} sections`);
                }
                else if (data.event === 'expert_generated') {
                    Logger.info(`ğŸ¤– Generated expert: ${data.expert_name}`);
                }
                else if (data.event === 'window_processing') {
                    Logger.info(`ğŸ” Processing Window ${data.window_num}/${data.total_windows}: Pages ${data.pages}`);
                    const progress = 30 + ((data.window_num / data.total_windows) * 60);
                    ProgressTracker.update(progress, `Window ${data.window_num}/${data.total_windows}`);
                }
                else if (data.event === 'experts_dispatched') {
                    Logger.info(`ğŸ¤– Dispatching ${data.expert_count} experts to analyze ${data.question_count} questions`);
                }
                else if (data.event === 'experts_complete') {
                    Logger.success(`âœ… Experts found ${data.answers_returned} answers (${data.tokens_used} tokens)`);
                }
                else if (data.event === 'window_complete') {
                    Logger.success(`âœ… Window ${data.window_num}: ${data.answers_found} answers (${data.processing_time.toFixed(1)}s)`);

                    // Display live unitary log if provided
                    if (data.unitary_log_markdown) {
                        displayLiveUnitaryLog(data.unitary_log_markdown);
                    }
                }
                else if (data.event === 'progress_milestone') {
                    Logger.info(`ğŸ“Š Progress: ${data.progress_summary}`);
                }
                else if (data.event === 'done') {
                    Logger.success('ğŸ‰ Analysis complete - fetching results...');
                    activeEventSource.close();
                    fetchResults();
                }
                else if (data.event === 'error') {
                    Logger.error(`âŒ Error: ${data.error}`);
                    activeEventSource.close();
                    throw new Error(data.error);
                }

            } catch (err) {
                Logger.error('Failed to parse SSE message: ' + err.message);
            }
        };

        activeEventSource.onerror = (err) => {
            Logger.warning('ğŸ“¡ Progress stream disconnected');
        };

        // STEP 3: Start analysis (returns immediately - runs in background)
        const analyzeResp = await fetch('/api/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                session_id: currentSessionId,
                pdf_path: pdfPath,
                context_guardrails: contextGuardrails || undefined
            })
        });

        if (!analyzeResp.ok) {
            throw new Error('Analysis failed to start');
        }

        const analyzeData = await analyzeResp.json();
        Logger.info(`âœ… Analysis started in background (Session: ${currentSessionId})`);

    } catch (error) {
        Logger.error('Analysis failed: ' + error.message);
        alert('Analysis failed: ' + error.message);
        ProgressTracker.hide();
        document.getElementById('analyzeBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
        if (activeEventSource) {
            activeEventSource.close();
        }
    }
}

// ============================================================================
// FETCH RESULTS (Called when 'done' event received)
// ============================================================================

async function fetchResults() {
    try {
        const resp = await fetch(`/api/results/${currentSessionId}`);
        const data = await resp.json();

        if (!data.success) {
            throw new Error(data.error);
        }

        currentAnalysisResult = data.result;

        Logger.success(`Questions answered: ${data.statistics.questions_answered}/${data.statistics.total_questions}`);
        Logger.success(`Processing time: ${data.statistics.processing_time.toFixed(2)}s`);
        Logger.success(`Estimated cost: ${data.statistics.estimated_cost}`);

        // Display results
        displayResults(data.result);
        displayStatistics(data.statistics);

        // Enable export
        document.getElementById('exportBtn').disabled = false;

        ProgressTracker.hide();
        document.getElementById('analyzeBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;

        // Clear session state (analysis complete)
        clearSessionState();

    } catch (error) {
        Logger.error('Failed to fetch results: ' + error.message);
    }
}

// ============================================================================
// DISPLAY RESULTS
// ============================================================================

function displayResults(result) {
    const resultsSection = document.getElementById('resultsSection');
    const resultsContent = document.getElementById('resultsContent');

    if (!result || !result.sections) {
        Logger.error('No results to display');
        return;
    }

    let html = '<div style="background: white; padding: 20px; border-radius: 8px;">';

    // Display each section
    result.sections.forEach(section => {
        html += `<h2>${section.section_name}</h2>`;

        section.questions.forEach(q => {
            html += `<div style="margin: 15px 0; padding: 10px; border-left: 3px solid #5b7fcc;">`;
            html += `<strong>Q: ${q.question}</strong><br>`;

            if (q.answer) {
                html += `<p style="margin: 10px 0;">${q.answer}</p>`;
                if (q.page_citations && q.page_citations.length > 0) {
                    html += `<small style="color: #666;">Pages: ${q.page_citations.join(', ')}</small>`;
                }
            } else {
                html += `<p style="color: #999; font-style: italic;">Not found in document</p>`;
            }

            html += `</div>`;
        });
    });

    html += '</div>';

    resultsContent.innerHTML = html;
    resultsSection.style.display = 'block';
}

function displayStatistics(stats) {
    const statsContent = document.getElementById('statisticsContent');

    const html = `
        <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
            <h3>Analysis Statistics</h3>
            <p><strong>Questions Answered:</strong> ${stats.questions_answered} / ${stats.total_questions}</p>
            <p><strong>Processing Time:</strong> ${stats.processing_time.toFixed(2)}s</p>
            <p><strong>Total Tokens:</strong> ${stats.total_tokens.toLocaleString()}</p>
            <p><strong>Estimated Cost:</strong> ${stats.estimated_cost}</p>
            <p><strong>Average Confidence:</strong> ${stats.average_confidence}</p>
        </div>
    `;

    statsContent.innerHTML = html;
}

function displayLiveUnitaryLog(markdownContent) {
    const resultsSection = document.getElementById('resultsSection');
    const resultsContent = document.getElementById('resultsContent');

    // Simple markdown to HTML
    const htmlContent = markdownContent
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/^# (.+)$/gm, '<h1>$1</h1>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/\n/g, '<br>');

    resultsContent.innerHTML = `<div style="background: white; padding: 20px; border-radius: 8px;">${htmlContent}</div>`;
    resultsSection.style.display = 'block';
}

// ============================================================================
// STOP ANALYSIS
// ============================================================================

async function stopAnalysis() {
    if (!currentSessionId) {
        Logger.warning('No active analysis to stop');
        return;
    }

    try {
        const resp = await fetch(`/api/stop/${currentSessionId}`, {
            method: 'POST'
        });

        const data = await resp.json();

        if (data.success) {
            Logger.warning('â¹ï¸ Analysis stopped by user');
            if (activeEventSource) {
                activeEventSource.close();
            }
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('analyzeBtn').disabled = false;
            ProgressTracker.hide();

            // Clear session state
            clearSessionState();
        }

    } catch (error) {
        Logger.error('Failed to stop analysis: ' + error.message);
    }
}

// ============================================================================
// EXPORT FUNCTIONS (Simplified)
// ============================================================================

function showExportMenu() {
    const menu = document.getElementById('exportMenu');
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

function exportResults(format) {
    if (!currentAnalysisResult) {
        alert('No results to export');
        return;
    }

    Logger.info(`ğŸ“¤ Exporting as ${format}...`);

    if (format === 'json') {
        downloadJSON(currentAnalysisResult, 'cipp_analysis.json');
    }
    else if (format === 'csv') {
        downloadCSV(currentAnalysisResult);
    }
    else if (format === 'excel-simple') {
        exportExcelSimple(currentAnalysisResult);
    }
    else if (format === 'html') {
        exportHTML(currentAnalysisResult);
    }
    else if (format === 'markdown') {
        exportMarkdown(currentAnalysisResult);
    }
    else {
        alert(`Export format ${format} not yet implemented`);
    }

    document.getElementById('exportMenu').style.display = 'none';
}

function downloadJSON(data, filename) {
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
}

function downloadCSV(data) {
    let csv = 'Section,Question,Answer,Pages\n';

    data.sections.forEach(section => {
        section.questions.forEach(q => {
            const answer = q.answer ? q.answer.replace(/"/g, '""') : 'Not found';
            const pages = q.page_citations ? q.page_citations.join(';') : '';
            csv += `"${section.section_name}","${q.question}","${answer}","${pages}"\n`;
        });
    });

    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'cipp_analysis.csv';
    a.click();
}

function exportExcelSimple(data) {
    // Create workbook
    const wb = XLSX.utils.book_new();
    const wsData = [['Section', 'Question', 'Answer', 'Page Citations']];

    data.sections.forEach(section => {
        section.questions.forEach(q => {
            wsData.push([
                section.section_name,
                q.question,
                q.answer || 'Not found in document',
                q.page_citations ? q.page_citations.join(', ') : ''
            ]);
        });
    });

    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // Professional styling with text wrapping and 15pt font
    ws['!cols'] = [
        {wch: 35},  // Section - wider
        {wch: 70},  // Question - wider
        {wch: 90},  // Answer - wider
        {wch: 22}   // Pages
    ];

    // Set row heights for text wrapping (60 pixels = readable with 15pt font)
    const rowHeights = {};
    for (let i = 1; i <= wsData.length; i++) {
        rowHeights[i] = {hpt: 60};
    }
    ws['!rows'] = Object.values(rowHeights);

    // Apply text wrapping to all cells
    const range = XLSX.utils.decode_range(ws['!ref']);
    for (let R = range.s.r; R <= range.e.r; ++R) {
        for (let C = range.s.c; C <= range.e.c; ++C) {
            const cell_address = {c: C, r: R};
            const cell_ref = XLSX.utils.encode_cell(cell_address);
            if (!ws[cell_ref]) continue;

            // Set cell style with text wrapping
            if (!ws[cell_ref].s) ws[cell_ref].s = {};
            ws[cell_ref].s = {
                alignment: {
                    wrapText: true,
                    vertical: 'top'
                },
                font: {
                    sz: 15,
                    name: 'Calibri'
                }
            };

            // Bold header row
            if (R === 0) {
                ws[cell_ref].s.font = {
                    sz: 15,
                    bold: true,
                    name: 'Calibri'
                };
                ws[cell_ref].s.fill = {
                    fgColor: {rgb: "1E3A8A"}
                };
            }
        }
    }

    XLSX.utils.book_append_sheet(wb, ws, 'Analysis Results');
    XLSX.writeFile(wb, 'cipp_analysis.xlsx');
    Logger.success('âœ… Professional Excel file downloaded (15pt font, text wrapping)');
}

function exportHTML(data) {
    let html = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CIPP Executive Analysis Report</title>
    <style>
        @page { margin: 1in; }
        body {
            font-family: Calibri, Arial, sans-serif;
            font-size: 15pt;
            line-height: 1.6;
            margin: 40px;
            background: #f5f5f5;
            color: #333;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #1E3A8A;
            font-size: 28pt;
            border-bottom: 4px solid #5B7FCC;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        h2 {
            color: #5B7FCC;
            font-size: 20pt;
            margin-top: 35px;
            margin-bottom: 20px;
            border-left: 6px solid #1E3A8A;
            padding-left: 15px;
        }
        .meta {
            font-size: 14pt;
            color: #666;
            margin-bottom: 30px;
            font-style: italic;
        }
        .question {
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-left: 6px solid #5B7FCC;
            border-radius: 6px;
            break-inside: avoid;
        }
        .question strong {
            color: #1E3A8A;
            font-size: 16pt;
            display: block;
            margin-bottom: 12px;
        }
        .answer {
            margin-top: 12px;
            color: #333;
            font-size: 15pt;
            line-height: 1.7;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .pages {
            margin-top: 12px;
            padding: 8px 12px;
            background: #e7f3ff;
            border-left: 3px solid #2196F3;
            font-size: 14pt;
            color: #0056b3;
            border-radius: 4px;
        }
        .not-found {
            color: #dc3545;
            font-style: italic;
            font-size: 15pt;
        }
        .answered-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #d4edda;
            color: #155724;
            border-radius: 4px;
            font-size: 13pt;
            font-weight: bold;
            margin-left: 10px;
        }
        .unanswered-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #f8d7da;
            color: #721c24;
            border-radius: 4px;
            font-size: 13pt;
            font-weight: bold;
            margin-left: 10px;
        }
        @media print {
            body { background: white; margin: 0; }
            .container { box-shadow: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ï¸ CIPP Bid-Spec Analysis</h1>
        <h1>Executive Report</h1>
        <p class="meta">Generated: ${new Date().toLocaleString()}</p>
`;

    data.sections.forEach(section => {
        const totalInSection = section.questions.length;
        const answeredInSection = section.questions.filter(q => q.answer).length;

        html += `<h2>${section.section_name} <span class="${answeredInSection === totalInSection ? 'answered' : 'unanswered'}-badge">${answeredInSection}/${totalInSection} Answered</span></h2>`;

        section.questions.forEach(q => {
            html += `<div class="question">`;
            html += `<strong>Q: ${q.question}</strong>`;
            if (q.answer) {
                html += `<div class="answer">${q.answer}</div>`;
                if (q.page_citations && q.page_citations.length > 0) {
                    html += `<div class="pages">ğŸ“„ <strong>Source Pages:</strong> ${q.page_citations.join(', ')}</div>`;
                }
            } else {
                html += `<div class="answer not-found">âœ— Not found in document</div>`;
            }
            html += `</div>`;
        });
    });

    html += `
    </div>
</body>
</html>`;

    const blob = new Blob([html], {type: 'text/html'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'cipp_analysis_report.html';
    a.click();
    Logger.success('âœ… HTML report downloaded');
}

function exportMarkdown(data) {
    let md = `# ğŸ—ï¸ CIPP Bid-Spec Analysis\n# Executive Report\n\n`;
    md += `**Generated:** ${new Date().toLocaleString()}\n\n`;
    md += `---\n\n`;

    // Executive Summary
    const totalQuestions = data.sections.flatMap(s => s.questions).length;
    const answeredQuestions = data.sections.flatMap(s => s.questions).filter(q => q.answer).length;
    const answerRate = ((answeredQuestions / totalQuestions) * 100).toFixed(1);

    md += `## ğŸ“Š Executive Summary\n\n`;
    md += `| Metric | Value |\n`;
    md += `|--------|-------|\n`;
    md += `| Total Questions | ${totalQuestions} |\n`;
    md += `| Questions Answered | ${answeredQuestions} |\n`;
    md += `| Unanswered | ${totalQuestions - answeredQuestions} |\n`;
    md += `| Answer Rate | ${answerRate}% |\n\n`;
    md += `---\n\n`;

    // Section Breakdown
    data.sections.forEach(section => {
        const totalInSection = section.questions.length;
        const answeredInSection = section.questions.filter(q => q.answer).length;

        md += `## ${section.section_name}\n\n`;
        md += `**Status:** ${answeredInSection}/${totalInSection} Answered (${((answeredInSection/totalInSection)*100).toFixed(1)}%)\n\n`;

        section.questions.forEach((q, idx) => {
            md += `### ${idx + 1}. ${q.question}\n\n`;
            if (q.answer) {
                md += `**Answer:**  \n${q.answer}\n\n`;
                if (q.page_citations && q.page_citations.length > 0) {
                    md += `> ğŸ“„ **Source Pages:** ${q.page_citations.join(', ')}\n\n`;
                }
            } else {
                md += `> âœ— **Not found in document**\n\n`;
            }
            md += `---\n\n`;
        });
    });

    md += `\n\n---\n\n`;
    md += `*Report generated by CIPP Bid-Spec Analyzer - Powered by HOTDOG AI*\n`;

    const blob = new Blob([md], {type: 'text/markdown'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'CIPP_Analysis_Executive_Report.md';
    a.click();
    Logger.success('âœ… Professional Markdown report downloaded');
}

// ============================================================================
// CLEAR RESULTS
// ============================================================================

function clearResults() {
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('resultsContent').innerHTML = '';
    document.getElementById('statisticsContent').innerHTML = '';
    document.getElementById('logContent').innerHTML = '';
    document.getElementById('exportBtn').disabled = true;
    currentAnalysisResult = null;
    currentSessionId = null;
    ProgressTracker.hide();
    Logger.info('ğŸ—‘ï¸ Results cleared');
}

// ============================================================================
// RESUME ON RETURN (Laptop Sleep Support)
// ============================================================================

function saveSessionState() {
    if (currentSessionId) {
        localStorage.setItem('cipp_active_session_id', currentSessionId);
        localStorage.setItem('cipp_session_start_time', Date.now().toString());
        Logger.debug('ğŸ’¾ Session state saved for resume');
    }
}

function checkForResumeSession() {
    const sessionId = localStorage.getItem('cipp_active_session_id');
    const startTime = localStorage.getItem('cipp_session_start_time');

    if (!sessionId || !startTime) return;

    const elapsedMinutes = (Date.now() - parseInt(startTime)) / (1000 * 60);

    // Only resume if within 30 minutes
    if (elapsedMinutes > 30) {
        Logger.info('â° Previous session expired (>30 min)');
        clearSessionState();
        return;
    }

    Logger.info(`ğŸ”„ Found recent session (${elapsedMinutes.toFixed(1)} min ago) - checking status...`);
    currentSessionId = sessionId;

    // Try to fetch results
    pollForResults();
}

async function pollForResults() {
    try {
        const resp = await fetch(`/api/results/${currentSessionId}`);

        if (resp.ok) {
            const data = await resp.json();

            if (data.success) {
                Logger.success('âœ… Analysis completed while you were away!');
                currentAnalysisResult = data.result;
                displayResults(data.result);
                displayStatistics(data.statistics);
                document.getElementById('exportBtn').disabled = false;
                clearSessionState();
            }
        } else {
            // Still running or not found
            Logger.info('â³ Analysis may still be running - reconnecting...');

            // Try to reconnect SSE
            reconnectSSE();
        }
    } catch (error) {
        Logger.warning('Could not resume session: ' + error.message);
        clearSessionState();
    }
}

function reconnectSSE() {
    const progressUrl = `/api/progress/${currentSessionId}`;
    activeEventSource = new EventSource(progressUrl);

    activeEventSource.onmessage = (e) => {
        try {
            const data = JSON.parse(e.data);

            if (data.event === 'done') {
                Logger.success('ğŸ‰ Analysis complete!');
                activeEventSource.close();
                fetchResults();
                clearSessionState();
            } else if (data.event === 'error') {
                Logger.error(`âŒ Error: ${data.error}`);
                activeEventSource.close();
                clearSessionState();
            }
        } catch (err) {
            Logger.error('SSE parse error: ' + err.message);
        }
    };

    activeEventSource.onerror = () => {
        Logger.warning('ğŸ“¡ Could not reconnect to progress stream');
        activeEventSource.close();

        // Retry polling in 5 seconds
        setTimeout(pollForResults, 5000);
    };
}

function clearSessionState() {
    localStorage.removeItem('cipp_active_session_id');
    localStorage.removeItem('cipp_session_start_time');
}

// ============================================================================
// INITIALIZATION
// ============================================================================

document.addEventListener('DOMContentLoaded', () => {
    Logger.info('ğŸš€ CIPP Bid-Spec Analyzer initialized (Clean Rebuild)');
    Logger.info('âœ… Ready for document analysis');

    // Load question configuration
    loadQuestionConfig();

    // Setup file drag-and-drop
    setupFileDragDrop();

    // Check for resumable session (laptop sleep support)
    checkForResumeSession();
});

function loadQuestionConfig() {
    // Default CIPP questions configuration
    questionConfig = {
        sections: [
            {id: 'project_info', name: 'Project Information', questions: 10, enabled: true},
            {id: 'pipe_specs', name: 'Pipe Specifications', questions: 10, enabled: true},
            {id: 'cipp_requirements', name: 'CIPP Liner Requirements', questions: 10, enabled: true},
            {id: 'pre_installation', name: 'Pre-Installation Work', questions: 10, enabled: true},
            {id: 'installation', name: 'Installation Process', questions: 10, enabled: true},
            {id: 'quality_control', name: 'Quality Control & Testing', questions: 10, enabled: true},
            {id: 'warranty', name: 'Warranty & Maintenance', questions: 10, enabled: true},
            {id: 'environmental', name: 'Environmental & Safety', questions: 10, enabled: true},
            {id: 'payment', name: 'Payment & Documentation', questions: 10, enabled: true},
            {id: 'special', name: 'Special Conditions', questions: 10, enabled: true}
        ],
        totalQuestions: 100
    };

    // Display sections
    const container = document.getElementById('questionSections');
    container.innerHTML = questionConfig.sections.map(section => `
        <div class="question-section ${section.enabled ? 'enabled' : 'disabled'}"
             onclick="toggleSection('${section.id}')">
            <span class="section-name">${section.name}</span>
            <span class="section-count">${section.questions}</span>
        </div>
    `).join('');

    updateActiveQuestionCount();
}

function updateActiveQuestionCount() {
    const count = questionConfig.sections
        .filter(s => s.enabled)
        .reduce((sum, s) => sum + s.questions, 0);

    document.getElementById('activeQuestionCount').textContent = count;
}

function setupFileDragDrop() {
    const dropZone = document.getElementById('fileUpload');

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#5b7fcc';
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.style.borderColor = '#ddd';
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#ddd';

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            document.getElementById('fileInput').files = files;
            handleFileSelect({target: {files: files}});
        }
    });
}

// ============================================================================
// DEBUG PANEL TOGGLE FUNCTIONS
// ============================================================================

function toggleMasterDebugPanel() {
    const panel = document.getElementById('masterDebugPanel');
    const icon = document.getElementById('masterDebugToggleIcon');
    const text = document.getElementById('masterDebugToggleText');

    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        icon.textContent = 'ğŸ”§';
        text.textContent = 'Hide Debug Tools';
    } else {
        panel.style.display = 'none';
        icon.textContent = 'ğŸ› ï¸';
        text.textContent = 'Show Debug Tools';
    }
}

function toggleDebugSection(sectionId) {
    const section = document.getElementById(sectionId);
    const header = section.previousElementSibling;
    const icon = header.querySelector('.toggle-icon');

    if (section.style.display === 'none' || !section.style.display) {
        section.style.display = 'block';
        header.classList.remove('collapsed');
        icon.textContent = 'â–²';
    } else {
        section.style.display = 'none';
        header.classList.add('collapsed');
        icon.textContent = 'â–¼';
    }
}

// ============================================================================
// STUB FUNCTIONS (To be implemented)
// ============================================================================

function loadTestDocument() {
    alert('Test document loader not implemented');
}

function showQuestionManager() {
    alert('Question manager not implemented');
}

function addQuestionSection() {
    alert('Add section not implemented');
}

function exportQuestions() {
    alert('Export questions not implemented');
}

function showSettings() {
    alert('Settings not implemented');
}

function toggleSection(sectionId) {
    const section = questionConfig.sections.find(s => s.id === sectionId);
    if (section) {
        section.enabled = !section.enabled;
        loadQuestionConfig();
    }
}

async function runSecondPass() {
    if (!currentSessionId || !currentAnalysisResult) {
        Logger.error('No analysis to run second pass on');
        alert('Please run initial analysis first');
        return;
    }

    try {
        Logger.info('ğŸ” Starting second pass analysis with enhanced scrutiny...');

        // Count unanswered questions
        const unansweredQuestions = currentAnalysisResult.sections
            .flatMap(s => s.questions)
            .filter(q => !q.answer || q.answer.trim() === '');

        Logger.info(`ğŸ“Š Found ${unansweredQuestions.length} unanswered questions`);

        document.getElementById('secondPassBtn').disabled = true;
        ProgressTracker.show();
        ProgressTracker.update(10, 'Preparing second pass...');

        // TODO: Implement second pass API endpoint
        alert('Second pass functionality will be implemented in the backend.\n\nThis feature will re-analyze unanswered questions with:\nâ€¢ Expanded search patterns\nâ€¢ Relaxed confidence thresholds\nâ€¢ Adjacent page scanning');

        ProgressTracker.hide();
        document.getElementById('secondPassBtn').disabled = false;

    } catch (error) {
        Logger.error('Second pass failed: ' + error.message);
        ProgressTracker.hide();
    }
}

async function exportExcelDashboard() {
    if (!currentSessionId || !currentAnalysisResult) {
        alert('No results to export');
        return;
    }

    Logger.info('ğŸ“Š Generating Executive Excel Dashboard with charts...');

    try {
        // Call server-side endpoint for professional Excel with openpyxl charts
        const url = `/api/export/excel-dashboard/${currentSessionId}`;

        const response = await fetch(url);

        if (!response.ok) {
            throw new Error('Excel generation failed');
        }

        // Download the file
        const blob = await response.blob();
        const downloadUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = 'CIPP_Executive_Dashboard.xlsx';
        a.click();
        URL.revokeObjectURL(downloadUrl);

        Logger.success('âœ… Executive Excel Dashboard downloaded with charts & professional formatting');
        document.getElementById('exportMenu').style.display = 'none';

    } catch (error) {
        Logger.error('Excel export failed: ' + error.message);
        alert('Excel export failed: ' + error.message);
    }
}

function exportLog() {
    const log = document.getElementById('logContent').innerText;
    downloadJSON({log: log}, 'activity_log.txt');
}

function clearLog() {
    document.getElementById('logContent').innerHTML = '';
}
    </script>
</html>