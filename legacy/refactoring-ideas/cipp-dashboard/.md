You are a master software engineer working in Claude Code on a Python-based CIPP lining dashboard.

Your job in THIS session:
**Refactor lifecycle progress logic and tables for CIPP segments so that progress is calculated correctly across all lifecycle stages, without “forgetting” earlier stages when a segment advances.**

Use the attached Excel file as ground truth:

- File: `SpreadSheet to use for creating new Dashboarding Sheet.xlsx`
- Sheet: `WEST DES MOINES, IA Shot Schedu`
- Header row: row 1

Each valid **row** is a **segment**. Each segment is one work item in the CIPP project.

---

## 1. Key Columns to Use (from the actual spreadsheet)

Inspect the header row and map these exact fields:

- Identification:
  - `VIDEO ID`
  - `Line Segment`
  - `LOCATION`
  - `US MH`
  - `USMH Depth`
  - `Prep USMH Depth`
  - `DS MH`
  - `DSMH Depth`
  - `Prep DSMH Depth`
  - `Pipe Size`

- Length / footage:
  - `Map Length`
  - `Shot Length`  
  **Rule:** Use `Map Length` as primary footage. If missing, fall back to `Shot Length`. Ignore rows with no usable footage.

- Prep status + prep details:
  - `Prep Complete`  (boolean-like)
  - `Ready to Line - Certified by Prep Crew Lead`  (boolean-like)
  - `Prep Crew`
  - `Prep Date`
  - `Prep USMH Depth`, `Prep DSMH Depth`
  - `Prep Rootsawing FT`, `Prep Rootsaw Hours`
  - `Prep Lumberjack FT`
  - `Prep Roller Tape FT`
  - Any `Prep ...` columns (they indicate that prep work has started/been done)

- Wet Out:
  - `Wet Out`  (treat as a date/flag; non-null means Wet Out is done for that segment)

- Installation / lining:
  - `Lining Date`  (non-null means CIPP Installed)

- Post-lining CCTV:
  - `Final Post TV Date`  (primary indicator for post CCTV complete)
  - Optionally: `Post TV`, `Post TV Video Rcvd` as secondary indicators if needed

Also capture:
- Reefer / Wet Out context: any fields that tie to Wet Out operations (e.g. `Wet Out`, any Reefer-related fields if present)
- Other contextual columns (Easement, Traffic Control, etc.) if/when you need them for KPIs.

---

## 2. Lifecycle Stages (Segment-Level)

Each segment can move through these **milestones**, in order:

1. **No Prep Started**
   - Segment has valid footage (`Map Length` or `Shot Length` > 0).
   - No prep or later-stage flags:
     - `Prep Complete` is false/blank.
     - `Ready to Line - Certified by Prep Crew Lead` is false/blank.
     - `Wet Out` is null.
     - `Lining Date` is null.
     - `Final Post TV Date` is null.
   - AND there is no evidence of prep activity:
     - `Prep Date` is null, and
     - All major prep metrics (`Prep Rootsawing FT`, `Prep Lumberjack FT`, `Prep Roller Tape FT`, etc.) are null/zero.

2. **Prep Complete**
   - `Prep Complete` is true.
   - Segment has been prepped (rootsaw, lumberjack, cleaning, etc.), but may not yet be Ready to Line.

3. **Ready to Line**
   - `Ready to Line - Certified by Prep Crew Lead` is true.
   - **Important:** Ready to Line is the controlling flag for readiness. Even if `Prep Complete` is false or missing, treat the segment as **Ready to Line** when this column is true.

4. **Wet Out**
   - `Wet Out` column is non-null (date or valid marker).
   - The segment is in the Wet Out cycle (resin impregnated, typically on the Reefer truck).

5. **CIPP Installed**
   - `Lining Date` is non-null.
   - The segment has been physically installed (liner in place).

6. **CCTV Post Complete**
   - `Final Post TV Date` is non-null.
   - Use this as the primary indicator of post-lining CCTV being complete.

---

## 3. Special Lifecycle Bucket: “Potential Issues”

Define a special classification:

> **Potential Issues** = segments where:
> - `Prep Complete` is true  
> - AND `Ready to Line - Certified by Prep Crew Lead` is **false/blank**

These are segments where prep work has been completed but they have not been certified as Ready to Line, suggesting bottlenecks, QA problems, or coordination issues.

You must:
- Build a **Potential Issues table** listing at least:
  - `VIDEO ID`
  - `Line Segment`
  - `Pipe Size`
  - `Map Length` (and/or `Shot Length`)
  - `US MH`, `USMH Depth`, `Prep USMH Depth`
  - `DS MH`, `DSMH Depth`, `Prep DSMH Depth`
  - `Prep Complete`
  - `Ready to Line - Certified by Prep Crew Lead`
  - `Wet Out`
  - `Lining Date`
  - `Final Post TV Date`
- Build a **Potential Issues KPI**:
  - Count of segments in this state.
  - Total footage of these segments (using the same footage rules as everywhere else).

---

## 4. Lifecycle Progress Calculation – Cumulative Model

We want a **cumulative progress model**, not an exclusive “one stage only” model.

Let the milestone order be:

1. Prep Complete  
2. Ready to Line  
3. Wet Out  
4. CIPP Installed  
5. CCTV Post Complete  

For each segment:
- Determine the **highest milestone** it has reached based on its row:

  - If `Final Post TV Date` is non-null → highest milestone = CCTV Post Complete.
  - Else if `Lining Date` is non-null → highest milestone = CIPP Installed.
  - Else if `Wet Out` is non-null → highest milestone = Wet Out.
  - Else if `Ready to Line - Certified by Prep Crew Lead` is true → highest milestone = Ready to Line.
  - Else if `Prep Complete` is true → highest milestone = Prep Complete.
  - Else → highest milestone = No Prep Started (no milestones reached).

Let `map_length_ft` for a segment be:
- `Map Length` if non-null, else `Shot Length` if non-null, else 0 (ignore if 0).

Let `F_total` = sum of `map_length_ft` over all valid segments.

For each milestone `M_k` in [Prep, Ready, Wet Out, Installed, CCTV]:

- Define coverage set `S_k` = all segments whose **highest milestone index** ≥ index of `M_k`.  
  - Example: A segment with `Final Post TV Date` set belongs in **all** milestone coverage sets:
    - Prep Complete
    - Ready to Line
    - Wet Out
    - CIPP Installed
    - CCTV Post Complete

- Compute:
  - `F_k = sum(map_length_ft for segments in S_k)`
  - `P_k = F_k / F_total`  (cumulative fraction of project footage that has ever reached `M_k`)

This ensures:
- `P_k` is **monotonically increasing** as we go from Prep → CCTV.
- Once a segment passes a milestone, it never stops counting toward that milestone’s progress.

If you need stacked bars that sum to 100%:
- Let `Delta_k = max(P_k − P_(k-1), 0)` with `P_0 = 0`.
- Use `Delta_k * 100` as the width for bar segment `M_k`.
- Show `P_k * 100` in labels/hover as the **cumulative** percentage.

Plain-English interpretation:
- “Prep Complete – 75%” = 75% of total project footage has been prepped at some point.  
- “CIPP Installed – 40%” = 40% of total footage has been installed; all of that 40% is also counted in the Prep, Ready, and Wet Out milestones.

---

## 5. No Prep Started vs Milestones

Classification rules for each row:

1. If `Final Post TV Date` is set:
   - Highest milestone = CCTV Post Complete.

2. Else if `Lining Date` is set:
   - Highest milestone = CIPP Installed.

3. Else if `Wet Out` is non-null:
   - Highest milestone = Wet Out.

4. Else if `Ready to Line - Certified by Prep Crew Lead` is true:
   - Highest milestone = Ready to Line.

5. Else if `Prep Complete` is true:
   - Highest milestone = Prep Complete.
   - If `Ready to Line - Certified by Prep Crew Lead` is false/blank → also put into **Potential Issues**.

6. Else (no above flags set):
   - If segment has valid footage and **no clear prep data** (`Prep Date` null AND major `Prep ...` metrics null), classify it as **No Prep Started**.

You may still keep a simple “current stage” field if needed (highest milestone name), but **all lifecycle progress metrics must use the cumulative model** above.

---

## 6. Lifecycle Tables & KPIs (per state)

For each of these lifecycle buckets:

- No Prep Started  
- Prep Complete  
- Ready to Line  
- Wet Out  
- CIPP Installed  
- CCTV Post Complete  
- Potential Issues  

Build:

1. **Segment tables** including:
   - IDs, pipe size, `Map Length`/`Shot Length`
   - Upstream/downstream MH and depths
   - Prep fields (Prep Date, Prep depths, Prep Rootsaw/Lumberjack, etc.)
   - `Wet Out`, `Lining Date`, `Final Post TV Date`
   - Any Reefer/Wet Out relevant fields
   - Easement / Traffic Control flags (if needed)

2. **Lifecycle-specific KPIs**, e.g.:
   - Total footage in this bucket
   - Segment count
   - Average segment length
   - Min / max / avg MH depths
   - Counts/footage involving Reefer/Wet Out
   - Key milestone dates (earliest/latest Wet Out, install, CCTV)

Make sure:
- Cumulative lifecycle progress uses the milestone coverage logic above.
- “Current status” views (how many segments are currently in Ready to Line, etc.) are clearly separated and documented as such.

Always preserve the truth of the work:

> **Advancing a segment into later stages must never remove it from the reported completion of earlier stages.**
